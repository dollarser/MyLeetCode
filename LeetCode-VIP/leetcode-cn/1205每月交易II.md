# 1205æ¯æœˆäº¤æ˜“II
<p><code>Transactions</code> è®°å½•è¡¨</p>

<pre>
+----------------+---------+
| Column Name    | Type    |
+----------------+---------+
| id             | int     |
| country        | varchar |
| state          | enum    |
| amount         | int     |
| trans_date     | date    |
+----------------+---------+
id æ˜¯è¿™ä¸ªè¡¨çš„ä¸»é”®ã€‚
è¯¥è¡¨åŒ…å«æœ‰å…³ä¼ å…¥äº‹åŠ¡çš„ä¿¡æ¯ã€‚
çŠ¶æ€åˆ—æ˜¯ç±»å‹ä¸º [approvedï¼ˆå·²æ‰¹å‡†ï¼‰ã€declinedï¼ˆå·²æ‹’ç»ï¼‰] çš„æšä¸¾ã€‚</pre>

<p><code>Chargebacks</code> è¡¨</p>

<pre>
+----------------+---------+
| Column Name    | Type    |
+----------------+---------+
| trans_id       | int     |
| trans_date     | date    |
+----------------+---------+
é€€å•åŒ…å«æœ‰å…³æ”¾ç½®åœ¨äº‹åŠ¡è¡¨ä¸­çš„æŸäº›äº‹åŠ¡çš„ä¼ å…¥é€€å•çš„åŸºæœ¬ä¿¡æ¯ã€‚
trans_id æ˜¯ transactions è¡¨çš„ id åˆ—çš„å¤–é”®ã€‚
æ¯é¡¹é€€å•éƒ½å¯¹åº”äºä¹‹å‰è¿›è¡Œçš„äº¤æ˜“ï¼Œå³ä½¿æœªç»æ‰¹å‡†ã€‚</pre>

<p>&nbsp;</p>

<p>ç¼–å†™ä¸€ä¸ª SQL&nbsp;æŸ¥è¯¢ï¼Œä»¥æŸ¥æ‰¾æ¯ä¸ªæœˆå’Œæ¯ä¸ªå›½å®¶/åœ°åŒºçš„ä¿¡æ¯ï¼šå·²æ‰¹å‡†äº¤æ˜“çš„æ•°é‡åŠå…¶æ€»é‡‘é¢ã€é€€å•çš„æ•°é‡åŠå…¶æ€»é‡‘é¢ã€‚</p>

<p><strong>æ³¨æ„ï¼š</strong>åœ¨æ‚¨çš„æŸ¥è¯¢ä¸­ï¼Œåªéœ€æ˜¾ç¤ºç»™å®šæœˆä»½å’Œå›½å®¶ï¼Œå¿½ç•¥æ‰€æœ‰ä¸ºé›¶çš„è¡Œã€‚</p>

<p>ä»¥ <strong>ä»»æ„é¡ºåº</strong> è¿”å›ç»“æœè¡¨ã€‚</p>

<p>æŸ¥è¯¢ç»“æœæ ¼å¼å¦‚ä¸‹æ‰€ç¤ºã€‚</p>

<p>&nbsp;</p>

<p><strong>ç¤ºä¾‹ 1:</strong></p>

<pre>
<strong>è¾“å…¥ï¼š</strong>
Transactions è¡¨ï¼š
+-----+---------+----------+--------+------------+
| id  | country | state    | amount | trans_date |
+-----+---------+----------+--------+------------+
| 101 | US      | approved | 1000   | 2019-05-18 |
| 102 | US      | declined | 2000   | 2019-05-19 |
| 103 | US      | approved | 3000   | 2019-06-10 |
| 104 | US      | declined | 4000   | 2019-06-13 |
| 105 | US      | approved | 5000   | 2019-06-15 |
+-----+---------+----------+--------+------------+
Chargebacks è¡¨ï¼š
+----------+------------+
| trans_id | trans_date |
+----------+------------+
| 102      | 2019-05-29 |
| 101      | 2019-06-30 |
| 105      | 2019-09-18 |
+----------+------------+
<strong>è¾“å‡ºï¼š</strong>
+---------+---------+----------------+-----------------+------------------+-------------------+
| month   | country | approved_count | approved_amount | chargeback_count | chargeback_amount |
+---------+---------+----------------+-----------------+------------------+-------------------+
| 2019-05 | US      | 1              | 1000            | 1                | 2000              |
| 2019-06 | US      | 2              | 8000            | 1                | 1000              |
| 2019-09 | US      | 0              | 0               | 1                | 5000              |
+---------+---------+----------------+-----------------+------------------+-------------------+</pre>
































# è§£é¢˜:
# 1.ã€é²¸æã€‘1205. æ¯æœˆäº¤æ˜“IIï¼ˆè€ƒç‚¹ï¼šunion all + left joinã€date_formatï¼‰
##### æ€è·¯

æœ¬é¢˜éš¾ç‚¹åœ¨äºå¦‚ä½•å¤„ç†``Chargebacks`è¡¨ï¼Œé¢˜ç›®ä¸­è¯´ï¼š**æ¯é¡¹é€€å•éƒ½å¯¹åº”äºä¹‹å‰è¿›è¡Œçš„äº¤æ˜“ï¼Œå³ä½¿æœªç»æ‰¹å‡†ã€‚**è¿™è¯´æ˜æˆ‘ä»¬åº”è¯¥ä½¿ç”¨`full outer join` æ„é€ chargebackè¿™ä¸ªstateï¼Œç„¶åå†å¯¹å¹´æœˆgroup byè®¡ç®—å„ç±»æŒ‡æ ‡ã€‚

> âš ï¸ MySQLæ²¡æœ‰full outer joinï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å…ˆleft joinå†union allã€‚ 

##### ç®—æ³•

1. union all

```sql
with cte as
(
    select * from transactions
    union all
    select id, country, 'chargeback' state, amount, c.trans_date
    from chargebacks c left join transactions t 
    on c.trans_id = t.id
) 
# å…¶å®æ˜¯full outer join
```

2. è®¡ç®—æŒ‡æ ‡

```sql
select 
    date_format(trans_date, '%Y-%m') month,  # è½¬æ¢å¹´æœˆ
    country,
    sum(state = 'approved') approved_count,
    sum(if(state = 'approved', amount, 0)) approved_amount,
    sum(state = 'chargeback') chargeback_count,
    sum(if(state = 'chargeback', amount, 0)) chargeback_amount
from cte 
group by month, country
having approved_count <> 0 or chargeback_amount <> 0
# æ³¨æ„ï¼šåœ¨æ‚¨çš„æŸ¥è¯¢ä¸­ï¼Œåªéœ€æ˜¾ç¤ºç»™å®šæœˆä»½å’Œå›½å®¶ï¼Œå¿½ç•¥æ‰€æœ‰ä¸ºé›¶çš„è¡Œã€‚
```

##### ç­”æ¡ˆ

```sql
with cte as
(
    select * from transactions
    union all
    select id, country, 'chargeback' state, amount, c.trans_date
    from chargebacks c left join transactions t 
    on c.trans_id = t.id
) 

select 
    date_format(trans_date, '%Y-%m') month, 
    country,
    sum(state = 'approved') approved_count,
    sum(if(state = 'approved', amount, 0)) approved_amount,
    sum(state = 'chargeback') chargeback_count,
    sum(if(state = 'chargeback', amount, 0)) chargeback_amount
from cte 
group by month, country
having approved_amount or chargeback_amount
```

ğŸ¥°è§‰å¾—è¿˜ä¸é”™çš„è¯ï¼Œç‚¹ä¸ªèµï¼ŒåŠ ä¸ªå…³æ³¨å§~ğŸ¥°
# 2.æ–°æ‰‹çœ‹ï¼ ä»é¢˜æ„ç†è§£åˆ° Mysql åŸºç¡€çŸ¥è¯† 
é¦–å…ˆè¿™ä¸ªé¢˜ç›®å°±æœ‰ç‚¹éš¾ä»¥ç†è§£ï¼Œæˆ‘æ¥å¸®ä½ ç†è§£ä¸€ä¸‹ã€‚

é¢˜ç›®æ„æ€å°±æ˜¯ï¼šä¸€äº›å•†å“è¢«ä¸€äº›é¡¾å®¢é€€æ¬¾äº†ï¼Œè¢«é€€æ¬¾çš„æœ‰ä¸¤ç§çŠ¶æ€ï¼š

+ approved ï¼ˆæ‰¹å‡†é€€æ¬¾ï¼‰
+ declined ï¼ˆæ‹’ç»é€€æ¬¾ï¼‰

`Transactions` è¿™ä¸ªè¡¨å°±æ˜¯è®°å½•æ‰€æœ‰è¦é€€æ¬¾çš„ã€Œäº¤æ˜“ä¿¡æ¯ã€ã€‚

`Chargebacks` è¿™ä¸ªè¡¨å°±æ˜¯è®°å½•æ‰€æœ‰å·²ç»é€€æ¬¾çš„ã€Œäº¤æ˜“ã€ã€‚

**æ³¨æ„ï¼å“ªæ€•æ˜¯åœ¨ Transactions é‡Œè¢«æ‹’ç»äº†ä¹Ÿå¯ä»¥é€€æ¬¾ï¼ï¼ˆå…·ä½“ä¸ºä»€ä¹ˆï¼Œæˆ‘ä»¬å°±ä¸çŸ¥é“äº†ï¼‰**

æˆ‘ä»¬è¦æ±‚çš„æ˜¯ï¼š

ä¸åŒå›½å®¶åœ¨ä¸åŒæœˆé‡Œæ¥å—çš„

+ æ‰¹å‡†é€€æ¬¾æ•°ç›®å’Œæ€»é¢ï¼ˆä¹Ÿå°±æ˜¯ Transactions é‡Œé¢çš„ approvedï¼‰
+ å·²ç»é€€æ¬¾æ•°ç›®å’Œæ€»é¢ï¼ˆä¹Ÿå°±æ˜¯ Chargebacks ä¸ Transactions è¿æ¥åçš„ä¿¡æ¯ï¼‰

å› æ­¤æˆ‘ä»¬éœ€è¦ç”¨ `UNION ALL`

`UNION ALL` éå¸¸ç®€å•ï¼Œå’Œ UNION å¯¹æ¯”ä¸€ä¸‹ä½ å°±çŸ¥é“äº†ï¼š

![](https://pic.leetcode-cn.com/b5eb76f2c9555d98d2514242a97aff81fb960234384aabd15c42ecd5f5380fb3-image.png)


![](https://pic.leetcode-cn.com/4363137a4f937a408a09d9db68f1da45dc333bc1c92dcfb802ba49a49f15d51f-image.png)


ï¼ˆå‰è€… UNION åè€… UNION ALLï¼‰

æˆ‘ä»¬æ¥çœ‹çœ‹ä»£ç ï¼š

```Mysql
SELECT month, country,
COUNT(IF(tag=1, 1, NULL)) AS approved_count,
SUM(IF(tag=1, amount, 0)) AS approved_amount,
COUNT(IF(tag=0, 1, NULL)) AS chargeback_count,
SUM(IF(tag=0, amount, 0)) AS chargeback_amount
FROM (
    SELECT country, amount, 1 AS tag,
    date_format(trans_date, '%Y-%m') AS month
    FROM Transactions
    WHERE state='approved'
    
    UNION ALL

    SELECT country, amount, 0 AS tag,
    date_format(c.trans_date, '%Y-%m') AS month
    FROM Transactions AS t RIGHT OUTER JOIN Chargebacks AS c
    ON t.id = c.trans_id
) AS temp
GROUP BY  month, country;

``` 

å…¶ä¸­ `tag = 1` è¡¨ç¤ºè¿™ä¸ªæ˜¯ approvedï¼Œ

`COUNT(IF(tag=1, 1, NULL)` è¿™ä¸ªè¯­å¥çš„æ„æ€æ˜¯ï¼š

å¦‚æœ tag = 1é‚£ä¹ˆå°±è®¡æ•°å¦åˆ™ä¸è®¡æ•°ï¼Œå‰é¢é‚£ä¸ª 1 æ˜¯å¤šå°‘éƒ½å¯ä»¥ã€‚
# 3.213 ms, åœ¨æ‰€æœ‰ mysql æäº¤ä¸­å‡»è´¥äº†95.78%çš„ç”¨æˆ·
213 ms, åœ¨æ‰€æœ‰ mysql æäº¤ä¸­å‡»è´¥äº†95.78%çš„ç”¨æˆ·

```
select month,
country,
count(case when state='approved' and tag=0 then 1 else null end ) as approved_count,
sum(case when state='approved' and tag=0 then amount else 0 end ) as approved_amount,
count(case when tag=1 then 1 else null end  ) as chargeback_count,
sum(case when  tag=1 then amount else 0 end ) as chargeback_amount
from(
select country,state,amount,date_format(c.trans_date,'%Y-%m') as month,1 as tag
from Transactions t   
right join Chargebacks c on t.id=c.trans_id
union all
select country,state,amount,date_format(t.trans_date,'%Y-%m') as month,0  as tag
from Transactions t  where state!='declined'
) a group by country,month order by month,country

```


Unionï¼šå¯¹ä¸¤ä¸ªç»“æœé›†è¿›è¡Œå¹¶é›†æ“ä½œï¼Œä¸åŒ…æ‹¬é‡å¤è¡Œï¼ŒåŒæ—¶è¿›è¡Œé»˜è®¤è§„åˆ™çš„æ’åºï¼›
Union Allï¼šå¯¹ä¸¤ä¸ªç»“æœé›†è¿›è¡Œå¹¶é›†æ“ä½œï¼ŒåŒ…æ‹¬é‡å¤è¡Œï¼Œä¸è¿›è¡Œæ’åºï¼›

è¿™é“é¢˜çš„çš„æ€è·¯å°±æ˜¯ 
å…ˆæŸ¥å‡º æ¯ä¸ªæœˆå’Œæ¯ä¸ªå›½å®¶/åœ°åŒºçš„å·²æ‰¹å‡†äº¤æ˜“çš„æ•°é‡åŠå…¶æ€»é‡‘é¢  
```
select country,state,amount,date_format(t.trans_date,'%Y-%m') as month,0  as tag
from Transactions t  where state!='declined'
```

å†æŸ¥å‡º æ¯ä¸ªæœˆå’Œæ¯ä¸ªå›½å®¶/åœ°åŒºçš„é€€å•çš„æ•°é‡åŠå…¶æ€»é‡‘é¢
```
select country,state,amount,date_format(c.trans_date,'%Y-%m') as month,1 as tag
from Transactions t   
right join Chargebacks c on t.id=c.trans_id

```

è¿›è¡Œåˆå¹¶ï¼Œåªé å·¦å³å…³è”æ˜¯å®Œæˆä¸äº†çš„ï¼Œ å› ä¸ºå®ƒè¦æ±‚Chargebacksé‡Œé¢çš„trans_dateä¹Ÿè¦è®¡å…¥è¿›å»ï¼Œ
æ³¨æ„åˆå¹¶çš„æ—¶å€™ ä¸è¦ç”¨Union è¿™ä¸ªä¼šå°†é‡å¤è¡Œè¦†ç›–æ‰ï¼Œåˆ¤æ–­æ˜¯å¦é‡å¤è¡Œå°±æ˜¯ å›½å®¶ å¹´æœˆ  é‡‘é¢ å‡ä¸€è‡´ è¿™æ˜¯å¾ˆå®¹æ˜“å‘ç”Ÿçš„

æœ€åcountç»Ÿè®¡ï¼Œsu mæ±‚å’Œï¼Œåˆ†ç»„æ’åº 

è¿™é‡Œç”¨äº†tagå»åŒºåˆ† æ˜¯äº¤æ˜“è¿˜æ˜¯é€€å• ï¼Œæ–¹ä¾¿åˆå¹¶ä¹‹åç»Ÿè®¡





# 4.ç­›é€‰ç¬¦åˆæ¡ä»¶çš„æ•°æ®unionèµ·æ¥å¹¶æ‰“ä¸Štagï¼Œç„¶ågroup byã€sum
```
with base as (
    select 'approved' tag, country, date_format(trans_date, '%Y-%m') month, amount
    from Transactions where state = 'approved'
    union all
    select 'chargeback' tag, t.country, date_format(c.trans_date, '%Y-%m') month, t.amount
    from Chargebacks c join Transactions t on c.trans_id = t.id
)
select month, country, 
       sum(if(tag = 'approved', 1, 0)) approved_count,
       sum(if(tag = 'approved', amount, 0)) approved_amount,
       sum(if(tag = 'chargeback', 1, 0)) chargeback_count,
       sum(if(tag = 'chargeback', amount, 0)) chargeback_amount
from base 
group by month, country;
```
