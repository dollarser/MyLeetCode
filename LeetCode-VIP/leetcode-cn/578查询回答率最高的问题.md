# 578æŸ¥è¯¢å›ç­”ç‡æœ€é«˜çš„é—®é¢˜
<p><code>SurveyLog</code> è¡¨ï¼š</p>

<div class="original__bRMd">
<div>
<pre>
+-------------+------+
| Column Name | Type |
+-------------+------+
| id          | int  |
| action      | ENUM |
| question_id | int  |
| answer_id   | int  |
| q_num       | int  |
| timestamp   | int  |
+-------------+------+
è¿™å¼ è¡¨æ²¡æœ‰ä¸»é”®ï¼Œå…¶ä¸­å¯èƒ½åŒ…å«é‡å¤é¡¹ã€‚
action æ˜¯ä¸€ä¸ª ENUM æ•°æ®ï¼Œå¯ä»¥æ˜¯ "show"ã€"answer" æˆ–è€… "skip" ã€‚
è¿™å¼ è¡¨çš„æ¯ä¸€è¡Œè¡¨ç¤ºï¼šID = id çš„ç”¨æˆ·å¯¹ question_id çš„é—®é¢˜åœ¨ timestamp æ—¶é—´è¿›è¡Œäº† action æ“ä½œã€‚
å¦‚æœç”¨æˆ·å¯¹åº”çš„æ“ä½œæ˜¯ "answer" ï¼Œanswer_id å°†ä¼šæ˜¯å¯¹åº”ç­”æ¡ˆçš„ id ï¼Œå¦åˆ™ï¼Œå€¼ä¸º null ã€‚
q_num æ˜¯è¯¥é—®é¢˜åœ¨å½“å‰ä¼šè¯ä¸­çš„æ•°å­—é¡ºåºã€‚
</pre>

<p>&nbsp;</p>

<p><strong>å›ç­”ç‡</strong> æ˜¯æŒ‡ï¼šåŒä¸€é—®é¢˜ç¼–å·ä¸­å›ç­”æ¬¡æ•°å æ˜¾ç¤ºæ¬¡æ•°çš„æ¯”ç‡ã€‚</p>

<p>ç¼–å†™ä¸€ä¸ª SQL æŸ¥è¯¢ä»¥æŠ¥å‘Š <strong>å›ç­”ç‡</strong> æœ€é«˜çš„é—®é¢˜ã€‚å¦‚æœæœ‰å¤šä¸ªé—®é¢˜å…·æœ‰ç›¸åŒçš„æœ€å¤§ <strong>å›ç­”ç‡</strong> ï¼Œè¿”å› <code>question_id</code> æœ€å°çš„é‚£ä¸ªã€‚</p>

<p>æŸ¥è¯¢ç»“æœå¦‚ä¸‹ä¾‹æ‰€ç¤ºã€‚</p>

<p>&nbsp;</p>

<p><strong>ç¤ºä¾‹ï¼š</strong></p>

<pre>
<strong>è¾“å…¥ï¼š</strong>
SurveyLog table:
+----+--------+-------------+-----------+-------+-----------+
| id | action | question_id | answer_id | q_num | timestamp |
+----+--------+-------------+-----------+-------+-----------+
| 5  | show   | 285         | null      | 1     | 123       |
| 5  | answer | 285         | 124124    | 1     | 124       |
| 5  | show   | 369         | null      | 2     | 125       |
| 5  | skip   | 369         | null      | 2     | 126       |
+----+--------+-------------+-----------+-------+-----------+
<strong>è¾“å‡ºï¼š</strong>
+------------+
| survey_log |
+------------+
| 285        |
+------------+
<strong>è§£é‡Šï¼š</strong>
é—®é¢˜ 285 æ˜¾ç¤º 1 æ¬¡ã€å›ç­” 1 æ¬¡ã€‚å›ç­”ç‡ä¸º 1.0 ã€‚
é—®é¢˜ 369 æ˜¾ç¤º 1 æ¬¡ã€å›ç­” 0 æ¬¡ã€‚å›ç­”ç‡ä¸º 0.0 ã€‚
é—®é¢˜ 285 å›ç­”ç‡æœ€é«˜ã€‚</pre>
</div>
</div>
































# è§£é¢˜:
# 1.æŸ¥è¯¢å›ç­”ç‡æœ€é«˜çš„é—®é¢˜
#### æ–¹æ³• 1ï¼šä½¿ç”¨ä¸¤ä¸ªå­æŸ¥è¯¢åˆ†åˆ«æ±‚å›ç­”æ¬¡æ•°ä¸å‡ºç°æ¬¡æ•°
##### æƒ³æ³•
$å›ç­”ç‡ = å›ç­”æ¬¡æ•° / å‡ºç°æ¬¡æ•°$ã€‚ä¸ºäº†æ±‚å¾—å›ç­”ç‡ï¼Œå¯ä»¥å…ˆåˆ†åˆ«æ±‚å‡ºæ¯ä¸ªé—®é¢˜çš„å›ç­”æ¬¡æ•°ä¸å‡ºç°æ¬¡æ•°ï¼Œå½¢æˆä¸¤ä¸ªå­è¡¨ï¼Œç„¶åå°†å­è¡¨åˆå¹¶å³å¯ã€‚

##### ç®—æ³•
æˆ‘ä»¬å¯ä»¥é¦–å…ˆä½¿ç”¨ `count` æ±‚å¾—æ¯ä¸ªé—®é¢˜å‡ºç°ä¸å›ç­”çš„æ¬¡æ•°ã€‚
```sql
(select question_id, count(*) as answer_cnt
    from survey_log
    where action = "answer"
    group by question_id) as AnswerCnt
```
ä»¥ä¸Šä»£ç å¯ä»¥æŸ¥è¯¢æ¯ä¸ªé—®é¢˜çš„å›ç­”æ¬¡æ•°ï¼Œå°†å­è¡¨å‘½åä¸º `AnswerCnt`ã€‚
```sql
(select question_id, count(*) as action_cnt
    from survey_log
    where action = "show"
    group by question_id) as ShowCnt
```
ä»¥ä¸Šä»£ç å¯ä»¥æŸ¥è¯¢æ¯ä¸ªé—®é¢˜çš„å‡ºç°æ¬¡æ•°ï¼Œå°†å­è¡¨å‘½åä¸º `ShowCnt`ã€‚
ç„¶åå°†ä¸¤ä¸ªè¡¨ç”¨ `join` æ“ä½œåˆå¹¶èµ·æ¥ï¼ŒåŒæ—¶æ±‚å›ç­”ç‡ï¼Œæ’åºå¹¶å–ç¬¬ä¸€åï¼š

```sql
select AnswerCnt.question_id as survey_log from
(select question_id, count(*) as answer_cnt
    from survey_log
    where action = "answer"
    group by question_id) as AnswerCnt
join
(select question_id, count(*) as action_cnt
    from survey_log
    where action = "show"
    group by question_id) as ShowCnt
on AnswerCnt.question_id = ShowCnt.question_id
order by AnswerCnt.answer_cnt / ShowCnt.action_cnt desc
limit 1
```

#### æ–¹æ³• 2ï¼šä½¿ç”¨ä¸€ä¸ªå­æŸ¥è¯¢åŒæ—¶æ±‚å›ç­”æ¬¡æ•°ä¸å‡ºç°æ¬¡æ•°
##### æƒ³æ³•
æ–¹æ³• 1 åœ¨æŸ¥è¯¢é—®é¢˜å›ç­”æ¬¡æ•°æ—¶ä½¿ç”¨äº† `where` å­å¥ç­›é€‰ç¬¦åˆæ¡ä»¶çš„æ•°æ®ï¼Œå› æ­¤ä¸èƒ½åŒæ—¶å¯¹é—®é¢˜çš„å‡ºç°æ¬¡æ•°è¿›è¡Œè®°æ•°ã€‚å› æ­¤å¯ä»¥è€ƒè™‘ä¸ä½¿ç”¨ `where` å­å¥ï¼Œè€Œæ˜¯ç›´æ¥ç”¨æ¡ä»¶åˆ¤æ–­å‡½æ•° `if` è®¡ç®—ç¬¦åˆæ¡ä»¶çš„æ•°æ®æ¡æ•°ã€‚
##### ç®—æ³•
SQL ä¸­çš„ `if` å‡½æ•°æœ‰ä¸‰ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°ä¸ºéœ€è¦åˆ¤æ–­çš„æ¡ä»¶ã€‚è‹¥æ¡ä»¶ä¸ºçœŸï¼Œåˆ™è¿”å›å€¼ä¸ºç¬¬äºŒä¸ªå‚æ•°ï¼›è‹¥æ¡ä»¶ä¸ºå‡ï¼Œåˆ™è¿”å›å€¼ä¸ºç¬¬ä¸‰ä¸ªå‚æ•°ã€‚å› æ­¤è¦æŸ¥è¯¢é—®é¢˜çš„å‡ºç°æ¬¡æ•°ï¼Œåªéœ€è¦è®¾è®¡æ¡ä»¶åˆ¤æ–­ `if(action='show', 1, 0)` å¹¶æŒ‰é—®é¢˜åˆ†ç»„æ±‚å’Œå³å¯ã€‚
```sql
select
    question_id,
    sum(if(action = 'answer', 1, 0)) as AnswerCnt,
    sum(if(action = 'show', 1, 0)) as ShowCnt
from
    survey_log
group by question_id
```
ä»¥ä¸Šçš„ä»£ç å¯ä»¥åŒæ—¶æŸ¥è¯¢æ¯ä¸ªé—®é¢˜çš„å‡ºç°æ¬¡æ•°ä»¥åŠå›ç­”æ¬¡æ•°ï¼Œåˆ†åˆ«å­˜å…¥ `AnswerCnt` ä¸ `ShowCnt` åˆ—ä¸­ã€‚éšåæˆ‘ä»¬å¯ä»¥åœ¨æ­¤è¡¨çš„åŸºç¡€ä¸Šæ±‚æ¯ä¸ªé—®é¢˜çš„å›ç­”ç‡å¹¶æ’åºå–æœ€å¤§è€…ã€‚
```sql
select question_id as survey_log
from (
  select
      question_id,
      sum(if(action = 'answer', 1, 0)) as AnswerCnt,
      sum(if(action = 'show', 1, 0)) as ShowCnt
  from
      survey_log
  group by question_id
) as tbl
order by (AnswerCnt / ShowCnt) desc
limit 1
```

#### æ–¹æ³• 3ï¼šä¸ä½¿ç”¨å­æŸ¥è¯¢ï¼Œç›´æ¥æ’åº
æ–¹æ³• 2 ä½¿ç”¨äº†ä¸€ä¸ªå­æŸ¥è¯¢ç”Ÿæˆä¸´æ—¶è¡¨ `tbl`ï¼Œä½†ä½¿ç”¨ `if` è¯­å¥åï¼Œå…¶å®å¯ä»¥ç›´æ¥è®¡ç®—å›ç­”ç‡ï¼Œè€Œä¸éœ€è¦è¿›è¡Œå­æŸ¥è¯¢ã€‚æœ€ç»ˆè®¾è®¡çš„æŸ¥è¯¢å¦‚ä¸‹ï¼š
```sql
select question_id as survey_log
from survey_log
group by question_id
order by sum(if(action = 'answer', 1, 0)) / sum(if(action = 'show', 1, 0)) desc
limit 1
```
# 2.ã€LC SQL70ã€‘578. æŸ¥è¯¢å›ç­”ç‡æœ€é«˜çš„é—®é¢˜(æœ€å€¼é—®é¢˜)
# é¢„å¤‡çŸ¥è¯†
**æœ€å¤§å€¼é—®é¢˜çš„ä¸‰ç§æ€è·¯**
```
- å†…å±‚ï¼šçª—å£æ’åå‡½æ•° AS rankingï¼Œå¤–å±‚ï¼šWHERE ranking=1
- HAVING Aggregate_function(å­—æ®µ)>=ALL(SELECT Aggregate_function(å­—æ®µ))
- ORDER BY å­—æ®µ DESCï¼ŒLIMIT 1
```

**æœ€å°å€¼é—®é¢˜çš„ä¸‰ç§æ€è·¯**
```
- å†…å±‚DENSE_RANK() OVER(ORDER BY å­—æ®µ ASC) AS rankingï¼Œå¤–å±‚WHERE ranking=1
- HAVING Aggregate_function()<=ALL(SELECT Aggregate_function())
- ORDER BY å­—æ®µ ASCï¼ŒLIMIT 1
```

**SUM IF & COUNT IF**
```
å¯¹æ¡ä»¶è¿›è¡Œè®¡æ•°ï¼šSUM(æ¡ä»¶)=SUM(if(æ¡ä»¶,1,0))
å¯¹æ¡ä»¶è¿›è¡Œè®¡æ•°ï¼šCOUNT(IF(æ¡ä»¶,1,null))

æ³¨ï¼šCOUNT(æ¡ä»¶)=COUNT(æ¡ä»¶,true,null)ï¼Œæ¡ä»¶æ»¡è¶³è¿”å›trueï¼Œå¦åˆ™è¿”å›null
```

# ç­”æ¡ˆ
**è§£æ³•ä¸€ï¼šçª—å£æ’åå‡½æ•°**
```
WITH cte AS(
    SELECT 
        question_id,
        DENSE_RANK() OVER(ORDER BY SUM(action='answer')/SUM(action='show') DESC,question_id ASC ) AS ranking
    FROM SurveyLog
    GROUP BY question_id
)

SELECT question_id AS survey_log
FROM cte
WHERE ranking=1
```
**è§£æ³•äºŒï¼šHAVING aggregate_function()>=ALL(SELECT aggregate_function())**
```
SELECT question_id AS survey_log
FROM SurveyLog
GROUP BY question_id
HAVING SUM(action='answer')/SUM(action='show')>=ALL(
    SELECT SUM(action='answer')/SUM(action='show')
    FROM SurveyLog
    GROUP BY question_id
)
ORDER BY question_id ASC
LIMIT 1
```

**è§£æ³•ä¸‰ï¼šORDER BY**
```
SELECT question_id AS survey_log
FROM SurveyLog
GROUP BY question_id
ORDER BY SUM(action = 'answer') / SUM(action = 'show') DESC, question_id ASC
LIMIT 1
```

# 3.ã€é²¸æã€‘578. æŸ¥è¯¢å›ç­”ç‡æœ€é«˜çš„é—®é¢˜ï¼ˆè€ƒç‚¹ï¼šorder by vs. å­æŸ¥è¯¢åŒ¹é… vs. çª—å£å‡½æ•°ï¼‰
##### æ€è·¯

- å¦‚ä½•è®¡ç®—å›ç­”ç‡ï¼Ÿ

`sum(action = 'answer') / sum(action = 'show')`

- æ ¹æ®å›ç­”ç‡æ’å€’åº
  - `order by sum(action = 'answer') / sum(action = 'show') desc, question_id`
  - `dense_rank() over(order by sum(action = 'answer') / sum(action = 'show') desc, question_id)`
- å–ç¬¬ä¸€ä¸ª

##### ç­”æ¡ˆ

```sql
# order by 
select question_id as survey_log
from SurveyLog
group by question_id
order by sum(action = 'answer') / sum(action = 'show') desc, question_id
limit 1

# having >= all ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œè¿™é‡Œçœç•¥


# rnk
select
    question_id as survey_log
from
(select
    a.*,
    dense_rank() over(order by sum(action = 'answer') / sum(action = 'show') desc, question_id) as rnk
 # è¿™é‡Œç”¨dense_rankæˆ–è€…å…¶ä»–éƒ½å¯ä»¥ï¼Œå› ä¸ºä¸å­˜åœ¨å¹³å±€çš„æƒ…å†µ
from SurveyLog a
group by question_id) t
where rnk=1
```


# 4.ã€track & traningã€‘æ€è·¯ç®€å•ï¼Œæ€§èƒ½é«˜æ•ˆ
### æ–¹ä¾¿å¿«é€Ÿå­¦ä¹ ç®—æ³•ä¸ç†è§£~
ğŸŒ‡ ç‚¹èµ ğŸ‘ æ”¶è— â­ç•™è¨€ ğŸ“ ä¸€é”®ä¸‰è¿ ~å…³æ³¨Jamï¼Œä»ä½ æˆ‘åšèµ·ï¼

**å…„å¼Ÿä¼šèƒŒå›ä½ ï¼Œå¥³äººä¼šç¦»å¼€ä½ ï¼Œé‡‘é’±ä¼šè¯±æƒ‘ä½ ï¼Œç”Ÿæ´»ä¼šåˆéš¾ä½ ï¼Œåªæœ‰æ•°å­¦ä¸ä¼šï¼Œä¸ä¼šå°±æ˜¯ä¸ä¼š**
**å¤©æ‰ä¸å¦ï¼Œå–å†³äºæœ€ç»ˆè¾¾åˆ°çš„é«˜åº¦ã€‚çœŸæ­£çš„å¤©æ‰æ˜¯é‚£äº›è„šè¸å®åœ°çš„äºº**
**é™ä¸‹å¿ƒæ¥å¥½å¥½åšè‡ªå·±ï¼Œèµ°ç¨³è„šä¸‹æ¯ä¸€æ­¥ï¼Œå°±æ˜¯æœ€å¥½çš„è·¯ï¼Œå¼ºè€…éƒ½æ˜¯å­¤ç‹¬çš„**

æ¨è python ç®—æ³•çš„ä¹¦ç±ï¼Œä½“ç³»åŒ–å­¦ä¹ ç®—æ³•ä¸æ•°æ®ç»“æ„ï¼Œç”¨æ­£ç¡®çš„æ–¹å¼æˆä¸ºofferæ”¶å‰²æœº
[leetcode](https://github.com/ls1248659692/leetcode) â€”â€”  **ç³»ç»ŸåŒ–å¿«é€Ÿå­¦ä¹ ç®—æ³•ï¼Œè¿™ä¸æ˜¯å†…å·ï¼Œè¿™åªæ˜¯æ‚„æ‚„åœ°åŠªåŠ›ï¼Œç„¶åæƒŠè‰³æ‰€æœ‰çš„äºº**
![image.png](https://pic.leetcode-cn.com/1649775330-IOhTAR-image.png)

---
### æ±‚è§£æ€è·¯
1. æ±‚è§£æ¯ä¸ªé—®é¢˜çš„å›ç­”ç‡
```
SELECT question_id, 
sum(if( answer_id is not null, 1 , 0 )) / sum(if( action='show', 1, 0)) tag
FROM surveylog
GROUP BY question_id
```
2. å¯¹å›ç­”ç‡æ’åºå¹¶è¿”å›æœ€å¤§å›ç­”ç‡çš„ question_id
```
row_number() over(order by tag desc) as rank_tag
rank_tag = 1
```


### ä»£ç 

```mysql
# Write your MySQL query statement below
SELECT 
    question_id  survey_log
FROM (
    SELECT 
        question_id,
        row_number() over(order by tag desc) as rank_tag
    FROM (
        SELECT question_id, 
        sum(if( answer_id is not null, 1 , 0 )) / sum(if( action='show', 1, 0)) tag
        FROM surveylog
        GROUP BY question_id
    ) t1 )  t2
WHERE rank_tag = 1
ORDER BY question_id;
```
