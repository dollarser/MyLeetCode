# 615å¹³å‡å·¥èµ„ï¼šéƒ¨é—¨ä¸å…¬å¸æ¯”è¾ƒ
<p>ç»™å¦‚ä¸‹ä¸¤ä¸ªè¡¨ï¼Œå†™ä¸€ä¸ªæŸ¥è¯¢è¯­å¥ï¼Œæ±‚å‡ºåœ¨æ¯ä¸€ä¸ªå·¥èµ„å‘æ”¾æ—¥ï¼Œæ¯ä¸ªéƒ¨é—¨çš„å¹³å‡å·¥èµ„ä¸å…¬å¸çš„å¹³å‡å·¥èµ„çš„æ¯”è¾ƒç»“æœ ï¼ˆé«˜ / ä½ / ç›¸åŒï¼‰ã€‚</p>

<p>&nbsp;</p>

<p>è¡¨ï¼š&nbsp;<code>salary</code></p>

<pre>| id | employee_id | amount | pay_date   |
|----|-------------|--------|------------|
| 1  | 1           | 9000   | 2017-03-31 |
| 2  | 2           | 6000   | 2017-03-31 |
| 3  | 3           | 10000  | 2017-03-31 |
| 4  | 1           | 7000   | 2017-02-28 |
| 5  | 2           | 6000   | 2017-02-28 |
| 6  | 3           | 8000   | 2017-02-28 |
</pre>

<p>&nbsp;</p>

<p><strong>employee_id</strong>&nbsp;å­—æ®µæ˜¯è¡¨&nbsp;<code>employee</code>&nbsp;ä¸­&nbsp;<strong>employee_id</strong>&nbsp;å­—æ®µçš„å¤–é”®ã€‚</p>

<p>&nbsp;</p>

<pre>| employee_id | department_id |
|-------------|---------------|
| 1           | 1             |
| 2           | 2             |
| 3           | 2             |
</pre>

<p>&nbsp;</p>

<p>å¯¹äºå¦‚ä¸Šæ ·ä¾‹æ•°æ®ï¼Œç»“æœä¸ºï¼š</p>

<p>&nbsp;</p>

<pre>| pay_month | department_id | comparison  |
|-----------|---------------|-------------|
| 2017-03   | 1             | higher      |
| 2017-03   | 2             | lower       |
| 2017-02   | 1             | same        |
| 2017-02   | 2             | same        |
</pre>

<p>&nbsp;</p>

<p><strong>è§£é‡Š</strong></p>

<p>&nbsp;</p>

<p>åœ¨ä¸‰æœˆï¼Œå…¬å¸çš„å¹³å‡å·¥èµ„æ˜¯ (9000+6000+10000)/3 = 8333.33...</p>

<p>&nbsp;</p>

<p>ç”±äºéƒ¨é—¨ &#39;1&#39; é‡Œåªæœ‰ä¸€ä¸ª <strong>employee_id</strong>&nbsp;ä¸º &#39;1&#39; çš„å‘˜å·¥ï¼Œæ‰€ä»¥éƒ¨é—¨ &#39;1&#39; çš„å¹³å‡å·¥èµ„å°±æ˜¯æ­¤äººçš„å·¥èµ„&nbsp;9000 ã€‚å› ä¸º 9000 &gt; 8333.33 ï¼Œæ‰€ä»¥æ¯”è¾ƒç»“æœæ˜¯ &#39;higher&#39;ã€‚</p>

<p>&nbsp;</p>

<p>ç¬¬äºŒä¸ªéƒ¨é—¨çš„å¹³å‡å·¥èµ„ä¸º&nbsp;<strong>employee_id</strong>&nbsp;ä¸º &#39;2&#39; å’Œ &#39;3&#39; ä¸¤ä¸ªäººçš„å¹³å‡å·¥èµ„ï¼Œä¸º (6000+10000)/2=8000 ã€‚å› ä¸º 8000 &lt; 8333.33 ï¼Œæ‰€ä»¥æ¯”è¾ƒç»“æœæ˜¯ &#39;lower&#39; ã€‚</p>

<p>&nbsp;</p>

<p>åœ¨äºŒæœˆç”¨åŒæ ·çš„å…¬å¼æ±‚å¹³å‡å·¥èµ„å¹¶æ¯”è¾ƒï¼Œæ¯”è¾ƒç»“æœä¸º &#39;same&#39; ï¼Œå› ä¸ºéƒ¨é—¨ &#39;1&#39; å’Œéƒ¨é—¨ &#39;2&#39; çš„å¹³å‡å·¥èµ„ä¸å…¬å¸çš„å¹³å‡å·¥èµ„ç›¸åŒï¼Œéƒ½æ˜¯ 7000 ã€‚</p>

<p>&nbsp;</p>
































# è§£é¢˜:
# 1.å¹³å‡å·¥èµ„ï¼šéƒ¨é—¨ä¸å…¬å¸æ¯”è¾ƒ
#### æ–¹æ³•ï¼šä½¿ç”¨ `avg()` å’Œ `case...when...` [Accepted]

**æƒ³æ³•**

é€šè¿‡å¦‚ä¸‹ 3 æ­¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚

**ç®—æ³•**

1. è®¡ç®—å…¬å¸æ¯ä¸ªæœˆçš„å¹³å‡å·¥èµ„
MySQL æœ‰ä¸€ä¸ªå†…ç½®å‡½æ•° avg() è·å¾—ä¸€åˆ—æ•°å­—çš„å¹³å‡å€¼ã€‚åŒæ—¶æˆ‘ä»¬éœ€è¦å°† *pay_date* åˆ—æŒ‰ä¸€å®šæ ¼å¼è¾“å‡ºä»¥ä¾¿åé¢ä½¿ç”¨ã€‚

```sql []
select avg(amount) as company_avg,  date_format(pay_date, '%Y-%m') as pay_month
from salary
group by date_format(pay_date, '%Y-%m')
;
```

| company_avg | pay_month |
|-------------|-----------|
| 7000.0000   | 2017-02   |
| 8333.3333   | 2017-03   |

2. è®¡ç®—æ¯ä¸ªéƒ¨é—¨æ¯ä¸ªæœˆçš„å¹³å‡å·¥èµ„
ä¸ºäº†å®ç°è¿™ä¸ªç›®æ ‡ï¼Œæˆ‘ä»¬å°† **salary** è¡¨å’Œ **employee** è¡¨ç”¨æ¡ä»¶ `salary.employee_id = employee.id` è¿æ¥èµ·æ¥ã€‚

```sql []
select department_id, avg(amount) as department_avg, date_format(pay_date, '%Y-%m') as pay_month
from salary
join employee on salary.employee_id = employee.employee_id
group by department_id, pay_month
;
```

| department_id | department_avg | pay_month |
|---------------|----------------|-----------|
| 1             | 7000.0000      | 2017-02   |
| 1             | 9000.0000      | 2017-03   |
| 2             | 7000.0000      | 2017-02   |
| 2             | 8000.0000      | 2017-03   |

3. å°† 2 ä¸­çš„è¡¨å’Œä¹‹å‰çš„å…¬å¸æ•°æ®ä½œæ¯”è¾ƒå¹¶æ±‚å‡ºç»“æœ
å¦‚æœæ²¡ç”¨è¿‡ MySQL çš„æµæ§åˆ¶è¯­å¥ [`case...when...`](https://dev.mysql.com/doc/refman/5.7/en/case.html) é‚£è¿™ä¸€æ­¥ä¼šæ˜¯æœ€éš¾çš„ã€‚

å°±åƒå…¶ä»–è¯­è¨€ä¸€æ ·ï¼ŒMySQL ä¹Ÿæœ‰æµæ§åˆ¶è¯­å¥ï¼Œç‚¹å‡» [è¿™é‡Œ](https://dev.mysql.com/doc/refman/5.7/en/flow-control-statements.html) äº†è§£æ›´å¤šã€‚

æœ€åï¼Œå°†ä¸Šé¢ä¸¤ä¸ªæŸ¥è¯¢ç»“åˆèµ·æ¥å¹¶ç”¨ `on department_salary.pay_month = company_salary.pay_month` å°†å®ƒä»¬è¿æ¥ã€‚

```sql []
select department_salary.pay_month, department_id,
case
  when department_avg>company_avg then 'higher'
  when department_avg<company_avg then 'lower'
  else 'same'
end as comparison
from
(
  select department_id, avg(amount) as department_avg, date_format(pay_date, '%Y-%m') as pay_month
  from salary join employee on salary.employee_id = employee.employee_id
  group by department_id, pay_month
) as department_salary
join
(
  select avg(amount) as company_avg,  date_format(pay_date, '%Y-%m') as pay_month from salary group by date_format(pay_date, '%Y-%m')
) as company_salary
on department_salary.pay_month = company_salary.pay_month
;
```

# 2.ã€é²¸æã€‘615. å¹³å‡å·¥èµ„ï¼šéƒ¨é—¨ä¸å…¬å¸æ¯”è¾ƒï¼ˆè€ƒç‚¹ï¼šçª—å£å‡½æ•°ã€case whenã€date_formatï¼‰
##### æ€è·¯

é¦–å…ˆè®¡ç®—**æ¯ä¸ªéƒ¨é—¨çš„å¹³å‡å·¥èµ„ä¸å…¬å¸çš„å¹³å‡å·¥èµ„**ï¼Œä»æ•°æ®å±‚é¢å‡ºå‘ï¼Œå…ˆåˆ©ç”¨çª—å£å‡½æ•°æ‰©å……æ•°æ®ï¼ˆå¢åŠ åˆ—ï¼‰ï¼Œå†ç”¨æ¡ä»¶ç­›é€‰ã€‚

##### ç®—æ³•

1. è®¡ç®—**æ¯ä¸ªéƒ¨é—¨çš„å¹³å‡å·¥èµ„ä¸å…¬å¸çš„å¹³å‡å·¥èµ„**

```sql
-- éƒ¨é—¨
avg(amount) over(partition by department_id, pay_date) 
-- å…¬å¸
avg(amount) over(partition by pay_date) 
```

2. case when è½¬åŒ–

```sql
case
    when
        avg(amount) over(partition by department_id, pay_date) 
        < avg(amount) over(partition by pay_date) then "lower"
    when 
        avg(amount) over(partition by department_id, pay_date) 
        > avg(amount) over(partition by pay_date) then "higher"
    else 'same' end as comparison
```

3. left joinæ•´åˆå³å¯

##### ç­”æ¡ˆ

```sql
select distinct * from
(select 
    date_format(s.pay_date, '%Y-%m') as pay_month, 
    e.department_id, 
    case 
        when avg(amount) over (partition by e.department_id, s.pay_date) 
            < avg(amount) over (partition by s.pay_date) then 'lower'
        when avg(amount) over (partition by e.department_id, s.pay_date) 
            > avg(amount) over (partition by s.pay_date) then 'higher'
    else 'same' end as comparison
from salary s left join employee e
on s.employee_id = e.employee_id) a
order by 1 desc
```

ğŸ¥°è§‰å¾—è¿˜ä¸é”™çš„è¯ï¼Œç‚¹ä¸ªèµï¼ŒåŠ ä¸ªå…³æ³¨å§~ğŸ¥°
# 3.ä¸¤ä¸ªé‡ç‚¹è§£å¹³å‡å·¥èµ„ï¼šéƒ¨é—¨ä¸å…¬å¸æ¯”è¾ƒ
è¿™é¢˜æœ‰ä¸¤ä¸ªé‡ç‚¹ï¼š

1. éƒ¨é—¨æ¯ä¸ªæœˆçš„å¹³å‡è–ªèµ„
2. å…¬å¸æ¯ä¸ªæœˆçš„å¹³å‡è–ªèµ„

## SQL

```sql

select 
	distinct date_format(pay_date, '%Y-%m') as pay_month,
	department_id,
	(case when avg_department > avg_company then 'higher'
				when avg_department < avg_company then 'lower'
				else 'same'
	end) as comparison
from (
	select
		pay_date,
		department_id,
		avg(amount) as avg_department
	from salary join employee using(employee_id)
	group by pay_date, department_id
) as temp1 join (
	select pay_date, avg(amount) as avg_company from salary group by pay_date
) as temp2 using(pay_date)

--- ç­‰ä»·äº

select 
	pay_month,
	department_id,
	(case when avg_department > avg_company then 'higher'
				when avg_department < avg_company then 'lower'
				else 'same'
	end) as comparison
from (
	select
		date_format(pay_date, '%Y-%m') as pay_month, 
		department_id,
		avg(amount) as avg_department
	from salary join employee using(employee_id)
	group by pay_month, department_id
) as temp1 join (
	select 
		date_format(pay_date, '%Y-%m') as pay_month, 
		avg(amount) as avg_company
	from salary group by pay_month
) as temp2 using(pay_month)
```

## è§£æ

è®¡ç®—éƒ¨é—¨æ¯ä¸ªæœˆçš„å¹³å‡è–ªèµ„ï¼Œå°† `salary` å’Œ `employee` ç”¨ `employee_id` è¿æ¥ï¼Œå¹¶ä¸”æŒ‰ç…§ ï¼Œè®¡ç®—å‡ºéƒ¨é—¨è–ªèµ„å¹³å‡å€¼ `avg_department` ï¼Œ `pay_month` å’Œ `department_id` è¿›è¡Œåˆ†ç»„ï¼Œå°†å®ƒä½œä¸ºä¸´æ—¶è¡¨ `temp1`

è®¡ç®—å…¬å¸æ¯ä¸ªæœˆçš„å¹³å‡è–ªèµ„æ¯”è¾ƒç®€å•ï¼Œç›´æ¥å¯¹ `salary` è¡¨æŒ‰ç…§ `pay_date` è¿›è¡Œåˆ†ç»„ï¼Œå¹¶ä¸”è®¡ç®—å‡ºå…¬å¸è–ªèµ„å¹³å‡å€¼ `avg_company`ï¼Œå°†å®ƒä½œä¸ºä¸´æ—¶è¡¨ `temp2`

å°† `temp1` å’Œ `temp2` ç”¨ `pay_date` è¿æ¥èµ·æ¥ï¼Œä½¿ç”¨ `case ... when ... end` è¯­å¥æ¯”è¾ƒ`avg_department` å’Œ `avg_company` çš„å¤§å°åè¾“å‡º `same` ã€ `higher`ã€ `lower`

å› ä¸ºè¿™é‡Œè¾“å‡ºçš„éƒ½æ˜¯æ—¥æœŸ `date` ï¼Œæ‰€ä»¥è¿™é‡Œè¦ä½¿ç”¨ `date_format()` å¯¹å®ƒè¿›è¡Œæ—¥æœŸæ ¼å¼åŒ–ã€‚

è¿™é‡Œè¦æ³¨æ„ä¸€ç‚¹çš„æ˜¯å› ä¸º `temp1` å’Œ `temp2` éƒ½æ˜¯ç”¨ `date` åˆ†ç»„çš„ï¼Œè€Œæœ€åæŸ¥å‡ºæ¥çš„æ•°æ®åªéœ€è¦æœˆä»½ï¼Œæ‰€ä»¥è¿™é‡Œå¯èƒ½ä¼šå‡ºç°é‡å¤çš„æ•°æ®ï¼Œéœ€è¦åœ¨æœ€åä½¿ç”¨ `distinct` å»é‡ï¼Œæˆ–è€…å‘¢åœ¨ `temp1` å’Œ `temp2` æ˜¯å°±ç›´æ¥ä½¿ç”¨ `month` è¿›è¡Œåˆ†ç»„ã€‚

æ›´å¤šè§£é¢˜ï¼šhttps://github.com/astak16/blog-mysql/issues/45
# 4.615.å¹³å‡å·¥èµ„ï¼šéƒ¨é—¨ä¸å…¬å¸çš„æ¯”è¾ƒï¼ˆCASE WHEN &çª—å£å‡½æ•°ï¼‰
# é¢˜ç›®è§£æ
-- æ±‚å‡ºåœ¨æ¯ä¸€ä¸ªå·¥èµ„å‘æ”¾æ—¥ï¼Œæ¯ä¸ªéƒ¨é—¨çš„å¹³å‡å·¥èµ„ä¸å…¬å¸çš„å¹³å‡å·¥èµ„çš„æ¯”è¾ƒç»“æœ ï¼ˆé«˜ / ä½ / ç›¸åŒï¼‰ã€‚

# è§£é¢˜æ€è·¯
-- åˆ¤æ–­æ¡ä»¶ä½¿ç”¨CASE WHEN
--æ¯ä¸ªéƒ¨é—¨çš„å¹³å‡å·¥èµ„ï¼šAVG() OVER(PARTITION BY e.department_id,s.pay_date)
  æ•´ä¸ªå…¬å¸çš„å¹³å‡å·¥èµ„ï¼šAVG() OVER(PARTITION BY s.pay_date)
-- æ—¥æœŸæ ¼å¼åŒ–ï¼špay_month :date_format()
-- ä¸¤è¡¨è¿æ¥ï¼šLEFT JOIN

```
SELECT DISTINCT *
FROM(
    SELECT DATE_FORMAT(s.pay_date,'%Y-%m') AS pay_month, e.department_id,
           CASE WHEN AVG(amount) OVER(PARTITION BY e.department_id,s.pay_date)
                <    AVG(amount) OVER(PARTITON BY s.pay_date) THEN 'Lower'
                WHEN AVG(amount) OVER(PARTITION BY e.department_id,s.pay_date)
                >    AVG(amount) OVER(PARTITON BY s.pay_date) THEN 'Higher'
               ELSE 'Same'
           END AS comparsion
    FROM Salary s LEFT JOIN Employee e ON e.employee_id = s.employee_id
) temp 
ORDER BY 1 DESC





```



